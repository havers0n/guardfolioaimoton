# Запись видео - MediaRecorder

Проект поддерживает автоматическую запись видео прямо из браузера через MediaRecorder API.

## Как это работает

1. **Автозапуск записи** - Запись начинается автоматически через 500ms после загрузки страницы
2. **Захват кадров** - Используется `html2canvas` для периодического захвата DOM (30 FPS)
3. **Canvas stream** - Захваченные кадры рендерятся на скрытый canvas, с которого идет запись через `canvas.captureStream()`
4. **MediaRecorder** - Записывает поток с canvas в формате WebM (VP9 codec)
5. **Автоматическая остановка** - Через 15 секунд (DURATION_MS) запись автоматически останавливается
6. **Скачивание файла** - Видео автоматически скачивается как `guardfolio-ai-narrative-[timestamp].webm`

## "Чистый" режим записи

При записи автоматически включается "чистый" режим:
- Скрывается курсор (`cursor: none`)
- Отключается скролл (`overflow: hidden`)
- Отключается выделение текста (`userSelect: none`)
- Скрываются dev элементы (с атрибутами `data-dev`, `data-testid`)

## Настройки записи

### Текущие параметры:
- **FPS**: 30 кадров в секунду
- **Формат**: WebM с VP9 codec
- **Битрейт**: 20 Mbps (высокое качество)
- **Длительность**: 15 секунд (управляется через DURATION_MS в src/constants.ts)

### Изменение параметров

В файле `components/VideoRecorder.tsx`:

```typescript
// Изменить FPS
const TARGET_FPS = 30; // изменить на нужное значение
const stream = canvas.captureStream(30); // должно совпадать с TARGET_FPS

// Изменить битрейт
videoBitsPerSecond: 20_000_000, // изменить на нужное значение (в битах/сек)

// Изменить длительность
// Длительность управляется через DURATION_MS в src/constants.ts
// VideoRecorder автоматически использует это значение
```

## Конвертация в MP4

Записанный файл `.webm` можно конвертировать в `.mp4` через ffmpeg:

```bash
ffmpeg -i guardfolio-ai-narrative-[timestamp].webm \
  -movflags faststart \
  -pix_fmt yuv420p \
  -profile:v high \
  -level 4.2 \
  output.mp4
```

Параметры:
- `-movflags faststart` - оптимизация для веб-проигрывателей (быстрый старт)
- `-pix_fmt yuv420p` - совместимость с большинством устройств
- `-profile:v high -level 4.2` - настройки кодека для широкой совместимости

## Ручной запуск записи

Если нужно запустить запись вручную (например, по кнопке), можно использовать состояние `isRecording`:

```typescript
const [isRecording, setIsRecording] = useState(false);

// Запуск записи
const handleStartRecording = () => {
  setIsRecording(true);
};

// Остановка записи
const handleStopRecording = () => {
  setIsRecording(false);
};
```

## Производительность

**Важно**: `html2canvas` может быть ресурсоемким, особенно при высоком FPS. Текущие настройки (30 FPS) обеспечивают хороший баланс между качеством и производительностью.

Для улучшения производительности:
- Уменьшите FPS (например, до 24)
- Уменьшите битрейт (например, до 10 Mbps)
- Используйте меньший scale в html2canvas (например, 0.5)

## Ограничения

- Запись работает только в современных браузерах, поддерживающих MediaRecorder API
- Chrome/Edge: полная поддержка VP9
- Firefox: поддержка WebM, но может использовать другой codec
- Safari: ограниченная поддержка MediaRecorder (может потребоваться другой формат)

## Отладка

В консоли браузера будут логи:
- Ошибки захвата кадров
- Размер финального файла после завершения записи

